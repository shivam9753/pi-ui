<div class="w-full">
  <!-- Standardized Header -->
  <app-admin-page-header
    title="User Management"
    subtitle="Manage user roles and permissions across the platform."
    [loading]="loading"
    [stats]="stats"
    (onRefresh)="loadUsers()">
  </app-admin-page-header>

  <!-- Filter Component -->
  <app-simple-submission-filter 
    [availableStatuses]="['user', 'writer', 'reviewer', 'admin']"
    [showSortOptions]="true"
    [sortField]="'createdAt'"
    [hideTypes]="true"
    [statusLabel]="'Role'"
    (filterChange)="onFilterChange($event)">
  </app-simple-submission-filter>

  <!-- Data Table -->
  <app-data-table
    [columns]="columns"
    [data]="users"
    [actions]="actions"
    [loading]="loading"
    loadingText="Loading users..."
    [selectable]="false"
    [rowClickable]="true"
    [pagination]="paginationConfig"
    itemLabel="users"
    [trackByFn]="trackByUserId"
    [badgeConfig]="badgeConfig"
    (onPageChange)="onTablePageChange($event)"
    (onSort)="onTableSort($event)">
    
    <!-- Custom Cell Template -->
    <ng-template #customCell let-item let-column="column">
      @switch (column.key) {
        @case ('user') {
          <div class="flex items-center">
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center">
              @if (item.profileImage) {
                <img
                  [src]="item.profileImage"
                  [alt]="item.username"
                  class="w-10 h-10 rounded-full object-cover" />
              } @else {
                <span class="text-white font-medium text-sm">
                  {{ (item.name || item.username).charAt(0).toUpperCase() }}
                </span>
              }
            </div>
            <div class="ml-4">
              <div class="text-sm font-medium text-gray-900">{{ item.name || item.username }}</div>
              <div class="text-sm text-gray-500">{{ item.email }}</div>
            </div>
          </div>
        }
        @case ('role') {
          <select
            [value]="item.role"
            (change)="changeUserRole(item, $event)"
            [disabled]="item.role === 'admin' || changingRoles.has(item._id)"
            class="text-sm px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed">
            <option value="user">User</option>
            <option value="writer">Writer</option>
            <option value="reviewer">Reviewer</option>
            <option value="admin" disabled>Admin</option>
          </select>
        }
      }
    </ng-template>

    <!-- Mobile Card Template -->
    <ng-template #mobileCard let-user let-actions="actions">
      <app-user-mobile-card
        [user]="user"
        [actions]="consistentUserActions"
        [showRoleSelector]="true"
        [isChangingRole]="changingRoles.has(user._id)"
        (roleChange)="onUserRoleChange($event)">
      </app-user-mobile-card>
    </ng-template>

    <!-- Empty State Template -->
    <ng-template #emptyState>
      <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
      </svg>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No users found</h3>
      <p class="text-gray-500">{{ searchQuery ? 'No users match your search criteria.' : 'No users available.' }}</p>
    </ng-template>
  </app-data-table>

  <!-- Toast Notifications -->
  @if (message) {
    <div class="fixed top-4 right-4 z-50 max-w-sm w-full">
      <div class="rounded-lg p-4 shadow-lg border"
        [class]="message.type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'">
        <div class="flex items-center">
          @if (message.type === 'success') {
            <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
          }
          @if (message.type === 'error') {
            <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
          }
          <span class="flex-1">{{ message.text }}</span>
          <pi-button variant="ghost" size="sm" (buttonClick)="clearMessage()" class="ml-4">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </pi-button>
        </div>
      </div>
    </div>
  }

  <!-- Edit User Modal -->
  @if (showEditModal && editingUser) {
    <div class="fixed inset-0 z-50 overflow-y-auto bg-gray-500 bg-opacity-75 flex items-center justify-center p-4" (click)="closeEditModal()">
      <!-- Modal panel -->
      <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-screen overflow-y-auto" (click)="$event.stopPropagation()">
        <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="sm:flex sm:items-start">
              <div class="w-full mt-3 text-center sm:mt-0 sm:text-left">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6">
                  Edit User: {{ editingUser.name || editingUser.username }}
                </h3>
                
                <!-- Form -->
                <form class="space-y-4">
                  <!-- Name -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input
                      type="text"
                      [(ngModel)]="editUserForm.name"
                      name="name"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="Enter full name"
                      required>
                  </div>

                  <!-- Email -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input
                      type="email"
                      [(ngModel)]="editUserForm.email"
                      name="email"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="Enter email address"
                      required>
                  </div>

                  <!-- Role -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select
                      [(ngModel)]="editUserForm.role"
                      name="role"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                      <option value="user">User</option>
                      <option value="writer">Writer</option>
                      <option value="reviewer">Reviewer</option>
                      <option value="admin">Admin</option>
                    </select>
                  </div>

                  <!-- Bio -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                    <textarea
                      [(ngModel)]="editUserForm.bio"
                      name="bio"
                      rows="3"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="Enter user bio..."></textarea>
                  </div>

                  <!-- Profile Image -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Profile Image</label>
                    
                    <!-- Current Image -->
                    @if (editingUser.profileImage && !previewUrl) {
                      <div class="mb-3">
                        <div class="text-sm text-gray-600 mb-2">Current Image:</div>
                        <img [src]="editingUser.profileImage" alt="Current" class="w-16 h-16 rounded-full object-cover border-2 border-gray-300">
                      </div>
                    }
                    
                    <!-- Image Preview -->
                    @if (previewUrl) {
                      <div class="mb-3">
                        <div class="text-sm text-gray-600 mb-2">New Image:</div>
                        <div class="relative inline-block">
                          <img [src]="previewUrl" alt="Preview" class="w-16 h-16 rounded-full object-cover border-2 border-gray-300">
                          <button
                            type="button"
                            (click)="removeImage()"
                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600">
                            Ã—
                          </button>
                        </div>
                      </div>
                    }
                    
                    <!-- File Input -->
                    <input
                      type="file"
                      (change)="onFileSelected($event)"
                      accept="image/*"
                      class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <p class="mt-1 text-xs text-gray-500">PNG, JPG, GIF up to 5MB (will be converted to AVIF for optimal compression)</p>
                  </div>
                </form>
              </div>
            </div>
          </div>
          
          <!-- Modal Footer -->
          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <pi-button
              variant="primary"
              [disabled]="loading || uploadingImage"
              [loading]="loading || uploadingImage"
              (buttonClick)="saveUserChanges()">
              @if (loading) {
                Saving...
              } @else if (uploadingImage) {
                Uploading...
              } @else {
                Save Changes
              }
            </pi-button>
            <pi-button
              variant="secondary"
              [disabled]="loading || uploadingImage"
              (buttonClick)="closeEditModal()">
              Cancel
            </pi-button>
        </div>
      </div>
    </div>
  }
</div>