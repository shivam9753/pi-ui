<!-- admin-user-management.component.html -->
<div class="w-full px-4 sm:px-6 lg:px-8 xl:px-12 py-8 bg-themed min-h-screen">
    <!-- Header -->
    <div class="border-b border-themed pb-6 mb-8">
      <h1 class="text-2xl md:text-3xl font-bold text-themed mb-2">
        User Management
      </h1>
      <p class="text-themed-secondary">
        Manage user roles and permissions across the platform.
      </p>
    </div>
  
    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-themed-card rounded-xl p-6 border border-themed shadow-sm hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-2xl font-bold text-themed mb-1">{{ totalUsers }}</p>
            <p class="text-sm text-themed-secondary">Total Users</p>
          </div>
          <div class="w-10 h-10 bg-themed-accent-light rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-themed-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
            </svg>
          </div>
        </div>
      </div>
  
      <div class="bg-themed-card rounded-xl p-6 border border-themed shadow-sm hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-2xl font-bold text-themed mb-1">{{ userStats.users }}</p>
            <p class="text-sm text-themed-secondary">Regular Users</p>
          </div>
          <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
        </div>
      </div>
  
      <div class="bg-themed-card rounded-xl p-6 border border-themed shadow-sm hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-2xl font-bold text-themed mb-1">{{ userStats.reviewers }}</p>
            <p class="text-sm text-themed-secondary">Reviewers</p>
          </div>
          <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
        </div>
      </div>
  
      <div class="bg-themed-card rounded-xl p-6 border border-themed shadow-sm hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-2xl font-bold text-themed mb-1">{{ userStats.admins }}</p>
            <p class="text-sm text-themed-secondary">Admins</p>
          </div>
          <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Filters and Search -->
    <div class="bg-themed-card rounded-lg p-4 mb-6 border border-themed">
      <div class="flex flex-col md:flex-row md:items-center gap-4">
        <!-- Filter Controls - Left Side -->
        <div class="flex flex-col sm:flex-row gap-3 flex-1">
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-themed-secondary whitespace-nowrap">Filter:</label>
            <select 
              [(ngModel)]="selectedRole" 
              (change)="onRoleFilterChange()"
              class="bg-themed-card border border-themed rounded-lg px-3 py-2 text-sm text-themed focus:ring-2 focus:ring-themed-accent focus:border-themed-accent transition-colors min-w-32">
              <option value="">All Roles</option>
              <option value="user">Users</option>
              <option value="reviewer">Reviewers</option>
              <option value="admin">Admins</option>
            </select>
          </div>
    
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-themed-secondary whitespace-nowrap">Sort:</label>
            <select 
              [(ngModel)]="sortBy" 
              (change)="loadUsers()"
              class="bg-themed-card border border-themed rounded-lg px-3 py-2 text-sm text-themed focus:ring-2 focus:ring-themed-accent focus:border-themed-accent transition-colors min-w-36">
              <option value="createdAt">Newest First</option>
              <option value="username">Username A-Z</option>
              <option value="email">Email A-Z</option>
              <option value="role">Role</option>
            </select>
          </div>
        </div>
    
        <!-- Search - Right Side -->
        <div class="relative w-full md:w-80">
          <input 
            type="text" 
            [(ngModel)]="searchQuery"
            (input)="onSearch()"
            placeholder="Search users by name or email..."
            class="w-full bg-themed-card border border-themed rounded-lg px-3 py-2 pr-10 text-sm text-themed placeholder-themed-tertiary focus:ring-2 focus:ring-themed-accent focus:border-themed-accent transition-colors">
          <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-themed-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
      </div>
    </div>
  
    <!-- Loading State -->
    <div *ngIf="loading" class="text-center py-12">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-themed-secondary">Loading users...</p>
    </div>
  
    <!-- Users Data Grid -->
    <div *ngIf="!loading" class="bg-themed-card rounded-xl shadow-sm border border-themed overflow-hidden">
      <!-- Desktop Table -->
      <div class="hidden md:block overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-themed-secondary">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-themed-secondary uppercase tracking-wide">
                User
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-themed-secondary uppercase tracking-wide">
                Role
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-themed-secondary uppercase tracking-wide">
                Joined
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-themed-secondary uppercase tracking-wide">
                Stats
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-themed-secondary uppercase tracking-wide">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-themed-card divide-y divide-themed">
            <tr *ngFor="let user of users; trackBy: trackByUserId" class="hover:bg-themed-hover transition-colors duration-150">
              <!-- User Info -->
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-full bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center">
                      <img *ngIf="user.profileImage" 
                           [src]="user.profileImage" 
                           [alt]="user.username"
                           class="h-10 w-10 rounded-full object-cover" />
                      <span *ngIf="!user.profileImage" class="text-white font-medium text-sm">
                        {{ user.username?.charAt(0)?.toUpperCase() }}
                      </span>
                    </div>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-themed">{{ user.username }}</div>
                    <div class="text-sm text-themed-secondary">{{ user.email }}</div>
                  </div>
                </div>
              </td>
  
              <!-- Role -->
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-3 py-1 rounded-lg text-sm font-medium bg-themed-tertiary text-themed border border-themed">
                  {{ user.role | titlecase }}
                </span>
              </td>
  
              <!-- Joined Date -->
              <td class="px-6 py-4 whitespace-nowrap text-sm text-themed-secondary">
                {{ user.createdAt | date:'MMM d, y' }}
              </td>
  
              <!-- Stats -->
              <td class="px-6 py-4 whitespace-nowrap text-sm text-themed-secondary">
                <div class="flex flex-col space-y-1">
                  <span>{{ user.stats?.totalPublished || 0 }} published</span>
                  <span>{{ user.stats?.followers || 0 }} followers</span>
                </div>
              </td>
  
              <!-- Actions -->
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex items-center space-x-2">
                  <!-- Role Change Dropdown -->
                  <select 
                    [value]="user.role"
                    (change)="changeUserRole(user, $event)"
                    [disabled]="user.role === 'admin' || changingRoles.has(user._id)"
                    class="text-xs py-1 px-2 w-auto min-w-24 bg-themed-card border border-themed rounded text-themed focus:ring-2 focus:ring-themed-accent focus:border-themed-accent"
                    [class.opacity-50]="changingRoles.has(user._id)">
                    <option value="user">User</option>
                    <option value="reviewer">Reviewer</option>
                    <option value="admin" [disabled]="true">Admin</option>
                  </select>
  
                  <!-- View Profile Button -->
                  <button 
                    (click)="viewUserProfile(user)"
                    class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md bg-themed-accent text-themed-inverse hover:bg-themed-accent-hover transition-colors duration-150">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
  
      <!-- Mobile Cards -->
      <div class="md:hidden space-y-4 p-4">
        <div *ngFor="let user of users; trackBy: trackByUserId" class="bg-themed-card rounded-lg p-4 border border-themed shadow-sm">
          <!-- User Header -->
          <div class="flex items-center mb-3">
            <div class="flex-shrink-0 h-12 w-12">
              <div class="h-12 w-12 rounded-full bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center">
                <img *ngIf="user.profileImage" 
                     [src]="user.profileImage" 
                     [alt]="user.username"
                     class="h-12 w-12 rounded-full object-cover" />
                <span *ngIf="!user.profileImage" class="text-white font-medium">
                  {{ user.username?.charAt(0)?.toUpperCase() }}
                </span>
              </div>
            </div>
            <div class="ml-3 flex-1">
              <div class="text-sm font-medium text-themed">{{ user.username }}</div>
              <div class="text-sm text-themed-secondary">{{ user.email }}</div>
            </div>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-themed-accent-light text-themed-accent border border-themed-accent">
              {{ user.role | titlecase }}
            </span>
          </div>
  
          <!-- User Details -->
          <div class="grid grid-cols-2 gap-4 text-sm mb-4">
            <div>
              <span class="text-themed-secondary">Joined:</span>
              <div class="text-themed">{{ user.createdAt | date:'MMM d, y' }}</div>
            </div>
            <div>
              <span class="text-themed-secondary">Published:</span>
              <div class="text-themed">{{ user.stats?.totalPublished || 0 }} works</div>
            </div>
          </div>
  
          <!-- Actions -->
          <div class="flex items-center justify-between">
            <select 
              [value]="user.role"
              (change)="changeUserRole(user, $event)"
              [disabled]="user.role === 'admin' || changingRoles.has(user._id)"
              class="text-sm py-2 px-3 w-32 bg-themed-card border border-themed rounded-lg text-themed focus:ring-2 focus:ring-themed-accent focus:border-themed-accent"
              [class.opacity-50]="changingRoles.has(user._id)">
              <option value="user">User</option>
              <option value="reviewer">Reviewer</option>
              <option value="admin" [disabled]="true">Admin</option>
            </select>
  
            <button 
              (click)="viewUserProfile(user)"
              class="text-sm py-2 px-4 bg-themed-accent text-themed-inverse rounded-lg hover:bg-themed-accent-hover transition-colors duration-150">
              View Profile
            </button>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Pagination -->
    <div *ngIf="!loading && users.length > 0" class="mt-6 flex flex-col sm:flex-row items-center justify-between">
      <div class="text-sm text-themed-secondary mb-4 sm:mb-0">
        Showing {{ (currentPage - 1) * pageSize + 1 }} to {{ Math().min(currentPage * pageSize, totalUsers) }} of {{ totalUsers }} users
      </div>
      
      <div class="flex items-center space-x-2">
        <button 
          (click)="previousPage()"
          [disabled]="currentPage === 1"
          class="px-4 py-2 bg-themed-card border border-themed rounded-lg text-themed hover:bg-themed-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
          Previous
        </button>
        
        <span class="px-3 py-2 text-sm text-themed">
          Page {{ currentPage }} of {{ totalPages }}
        </span>
        
        <button 
          (click)="nextPage()"
          [disabled]="currentPage === totalPages"
          class="px-4 py-2 bg-themed-card border border-themed rounded-lg text-themed hover:bg-themed-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
          Next
        </button>
      </div>
    </div>
  
    <!-- Empty State -->
    <div *ngIf="!loading && users.length === 0" class="text-center py-12">
      <div class="w-16 h-16 mx-auto bg-themed-secondary rounded-full flex items-center justify-center mb-4">
        <svg class="w-8 h-8 text-themed-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
        </svg>
      </div>
      <h3 class="text-lg font-medium text-themed mb-2">No users found</h3>
      <p class="text-themed-secondary">
        {{ searchQuery ? 'No users match your search criteria.' : 'No users available.' }}
      </p>
    </div>
  </div>
  
  <!-- Success/Error Messages -->
  <div *ngIf="message" class="fixed top-4 right-4 z-50 animate-fade-in">
    <div class="rounded-lg p-4 shadow-lg"
         [class.bg-green-100]="message?.type === 'success'"
         [class.border-green-400]="message?.type === 'success'"
         [class.text-green-700]="message?.type === 'success'"
         [class.bg-red-100]="message?.type === 'error'"
         [class.border-red-400]="message?.type === 'error'"
         [class.text-red-700]="message?.type === 'error'"
         class="border">
      <div class="flex items-center">
        <svg *ngIf="message.type === 'success'" class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        <svg *ngIf="message.type === 'error'" class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <span>{{ message?.text }}</span>
        <button (click)="clearMessage()" class="ml-4 text-current hover:opacity-75">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        </button>
      </div>
    </div>
  </div>